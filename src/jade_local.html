<!DOCTYPE html>
<html>
<head>
<link type="text/css" href="jade.css" rel="Stylesheet"/>
<!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>-->
<script src="jquery.js"></script>
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="jade.js"></script>
<script type="text/javascript" src="model.js"></script>
<script type="text/javascript" src="netlist.js"></script>
<!--<script type="text/javascript" src="icons.js"></script>-->
<script type="text/javascript" src="icons_no_fa.js"></script>
<script type="text/javascript" src="schematic_view.js"></script>
<script type="text/javascript" src="icon_view.js"></script>
<script type="text/javascript" src="property_view.js"></script>
<script type="text/javascript" src="test_view.js"></script>
<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="plot.js"></script>
<script type="text/javascript" src="device_level.js"></script>
<script type="text/javascript" src="cktsim.js"></script>
<script type="text/javascript" src="gate_level.js"></script>
<script type="text/javascript" src="gatesim.js"></script>
<script type="text/javascript" src="libraries.js"></script>

<script type="text/javascript">
// see if jade's URL includes an arg of the form 'dir=xxx'
// if so look file libraries in subdirectory xxx
jade.page_args = function () {
    var page_args = window.location.search.match(/\w+=[\w|\%|\:]+/g);
    result = {}
    if (page_args) {
        $.each(page_args,function (index,arg) {
            var key_value = arg.split('=');
            // if no value supplied, just use key as the value
            result[key_value[0]] = key_value[1] || key_value[0];
        });
    }
    return result;
}

jade.user_directory = function () {
    var user_dir = jade.page_args()['dir'] || 'guest';
    return user_dir;
}

jade.load_from_server = function (lib) {
    var user_dir = jade.user_directory();
    var args = {
        async: false, // hang until load completes
        url: 'server_local.cgi',
        type: 'POST',
        data: { file: user_dir + '/' + lib.name },
        dataType: 'json',
        error: function(jqXHR, textStatus, errorThrown) {
            alert('Error while loading library '+lib.name+': '+errorThrown);
        },
        success: function(json) {
            lib.load(json[0]);
            if (json[1] == 'shared') lib.read_only = true;
        }
    };
    $.ajax(args);
};

jade.save_to_server = function (lib) {
    var user_dir = jade.user_directory();
    var args = {
        url: 'server_local.cgi',
        type: 'POST',
        data: {
            file: user_dir + '/' + lib.name,
            json: JSON.stringify(lib.json())
        },
        error: function(jqXHR, textStatus, errorThrown) {
            alert(errorThrown);
        },
        success: function() {
            // clear modified status for library and its modules
            lib.clear_modified();
        }
    };
    $.ajax(args);
};

jade.request_zip_url = undefined;  //'/jade-server?zip=1';

jade.setup = (function () {
    // set up editor inside of div's with class "jade"
    function setup() {
        var args = jade.page_args();

        // look for nodes of class "jade" and give them an editor
        $('.jade').each(function(index, div) {
            // skip if this div has already been configured
            if (div.jade === undefined) {
                // now create the editor
                var j = new jade.Jade(div);

                // start configuration with whatever is provided by <jade> tag
                var config = {};
                if (args.edit) config.edit = args.edit;
                $.each(div.attributes,function () {
                    if (this.name != 'class') config[this.name] = this.value;
                });

                j.initialize(config);
            }
        });
    }

    //////////////////////////////////////////////////////////////////////
    //
    // Module exports
    //
    //////////////////////////////////////////////////////////////////////

    return {
        setup: setup,   // called to initialize jade editors on this page
    };

}());

// set up editor inside of div's with class "jade"
$(document).ready(jade.setup.setup);
</script>

</head>
<body>
<div class="jade" parts="analog,gates" hierarchical="true"></div>
<script>
// notify user of unsaved changes
$(window).bind('beforeunload',function () {
    if ($('body').attr('data-dirty') !== undefined)
        return 'You have unsaved changes on this page.';
    return undefined;
});
</script>
</body>
</html>
